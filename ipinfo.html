<!DOCTYPE html>
<html>
<head>
    <title>IP Info</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link
        type="text/css" rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Google+Sans:400,500,700|Google+Sans+Text:400&amp;lang=en">
    <style>
        #map {
            position: absolute;
            top: 0;
            right: 0;
            height: 100vh;
            width: 100vw;
        }
        #info {
            position: absolute;
            top: 0;
            right: 0;
            margin: 10px;
            padding: 9px 11px;
            width: 279.5px;
            background-color: white;
            border-radius: 2px;
            box-shadow: rgb(0 0 0 / 30%) 0px 1px 4px -1px;
            user-select: text;
            font-family: Roboto, Arial;
        }
        #ip {
            color: black;
            font-size: 14px;
            height: 16px;
            font-weight: 500;
        }
        #org {
            color: #5b5b5b;
            font-size: 12px;
            margin-top: 6px;
        }
        #details {
            text-decoration: none;
            color: #1a73e8;
            font-size: 12px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <iframe id="map"frameborder="0" scrolling="no"></iframe>

    <div id="info">
        <div id="ip">Loading...</div>
        <div id="org"></div>
        <div>
            <a id="details" href="#" target="_blank" aria-label="View details">View details</a>
        </div>
    </div>

    <script>
        window.initMap = () => {
          const map = new google.maps.Map(document.getElementById("map"), {
            mapId: "ipinfo",
            zoom: 3,
            center: { lat: 0, lng: 0 },
            gestureHandling: "greedy",
          });

          const marker = new google.maps.marker.AdvancedMarkerElement({
            map,
            title: 'Your location',
          });

          updateInfo(map, marker);
          window.addEventListener('online', () => updateInfo(map, marker));
        };
        
        async function getIpInfo() {
          const providers = [
            {
              url: 'https://api.ipbase.com/v2/info',
              map: (body) => ({
                ip: body.data.ip,
                organization: body.data.connection.organization,
                position: { 
                  lat: body.data.location.latitude, 
                  lng: body.data.location.longitude, },
              }),
            },
            {
              url: 'https://ipapi.co/json',
              map: (body) => ({
                ip: body.ip,
                organization: body.org,
                position: { lat: body.latitude, lng: body.longitude },
              }),
            },
            {
              url: 'https://ipinfo.io/json',
              map: (body) => {
                const [lat, lng] = body.loc.split(',').map(parseFloat);
                return {
                  ip: body.ip,
                  organization: body.org,
                  position: { lat, lng },
                };
              },
            },
          ];
        
          for (const provider of providers) {
            try {
              const response = await fetch(provider.url).then((res) => res.json());
              console.info(`Fetched from ${provider.url}:`, response);
              return {
                detailsUrl: provider.url,
                ...provider.map(response),
              };
            } catch (error) {
              console.info(`Error fetching from ${provider.url}:`, error);
            }
          }
        
          throw new Error('All ip info providers failed.');
        }

        async function updateInfo(map, marker) {
            const ipInfo = await getIpInfo();
            console.info('ipInfo:', ipInfo);

            const mapIframe = document.getElementById('map');
            mapIframe.src = `https://maps.google.com/maps?q=${ipInfo.position.lat},${ipInfo.position.lng}&z=10&output=embed`;

            const infoElement = document.getElementById('info');

            const ipElement = document.getElementById('ip');
            ipElement.innerText = ipInfo.ip;

            const orgElement = document.getElementById('org');
            orgElement.innerText = ipInfo.organization;

            const detailsElement = document.getElementById('details');
            detailsElement.href = ipInfo.detailsUrl;
        };
    </script>

    <script
          src="https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&loading=async&callback=initMap&key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao"
          defer
    ></script>
</body>
</html>
